---
title: "Classification and Predication: Stock Prices"
output: html_document
date: "2023-04-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggcorrplot)
library(dplyr)
library(timetk)
library(ggplot2)
library(gridExtra)
library(Metrics)
library(caret)
library(factoextra)
library(cluster)
```

## 1. Title & Introduction

### **Classification and Prediction: Stock Prices**

By: Abhinav Bichal, Wei-Yu Chiang

### **a. Introduction**

Our data set contains variables of many different stocks with their prices, dates, volume, and a handful of stock indicators. These indicators are our predictor variables and are widely used to analyze stocks, such as the simple moving average, which takes a stock's average price in the past certain number of days, which results in a line. The outcome variable we will try to predict is the closing prices of stocks at the end of the day. All of our stock indicators were personally coded by us and applied to our list of stock that we obtained from yahoo finance. The data is constantly up to date as we are pulling information directly from yahoo finance through an API. We chose this topic because investing is important for retirement and personal financial goals. We wanted to investigate stock market investing with data and how well these stock indicators could predict price. We expect most of our indicators to be strongly correlated with the stock price because they are derived from them. We want to focus on the regression equations that we obtain to analyze how close we can predict the next day's price.

### b. Describing the dataset

We utilized the Yahoo Finance Python API to get up-to-date information on stock prices (under the package name, yfinance). There are 500 stocks selected under the SP500 as of April 2023, and of all these stocks, we retrieved the adjusted closing price information for stocks. The time period that the data is collected from ranges from Jan 1st, 2021 to Apr 20th, 2023. After obtaining closing price information, we used Python to calculate the relevant indicators that should correlate with stock market price increases/ decreases. Here is a list of indicators calculated from our Jupyter Notebook and the potential relationships one might expect:

-   Simple Moving Average (10-day period) *longer term price movements*

    -   **relationship:** we speculate that stock prices that are upwards from the SMA line generally have a positive momentum, signaling that the stock might continue to uptrend. the converse is assumed for down-trending stocks.

-   Exponential Moving Average (10-day period) *shorter term fluctuations captured*

    -   **relationship:** exponential moving averages have the same concept of the SMA line, where we attempt to predict general directional trends of stock prices. However, the EMA line places more emphasis on more recent stock price fluctuations, which provide better short-term information on stock price changes. We speculate that stock prices rising above the EMA line will indicate *earlier* that there is an upwards trend in stock price

-   Relative Strength Index (14-day period averages)

    ![](images/Capture.JPG)

    (SOURCE: [What Is The Relative Strength Index (RSI) In Stocks? \| Nasdaq](https://www.nasdaq.com/articles/what-is-the-relative-strength-index-rsi-in-stocks))

    -   **relationship:** the relative strength index is a very common stock market indicator that describes whether a stock price is oversold or overbought based on the value given. Generally, RSI values of 30 or below indicate oversold stock prices, and RSI values of 70 or above indicate overbought. We speculate stock prices with a relatively low RSI value to be correlated with price increases. Vice-versa for high RSI values.

-   Moving Average Convergence / Divergence

    ![](images/macd_img.jpg){width="490"}

    (SOURCE: [Moving Average Convergence Divergence (MACD) - αlphαrithms (alpharithms.com)](https://www.alpharithms.com/moving-average-convergence-divergence-macd-031217/))

    -   The MACD line is another common indicator in stock market technical analysis. Generally speaking, when the signal MACD line (which is the shorter 9-day period subtracted by 26-day period of the exponential weighted means) crosses from below to above the MACD line, we consider the stock to begin an upwards movement. When the MACD signal crosses below the line, the stock is considered to go downwards.

    -   **relationship:** we speculate that the distance of MACD signal \* slope correlates with whether the stock price increases or decreases over a certain period of time.

### c. Research Questions

**Wei-Yu's Research Question:**

How accurately can we predict the stock price next day from stock indicators with linear regression?

**Abhinav's Research Question:**

Given a particular stock based on sentimental value, can we predict if the price will increase or decrease?

## 2. Exploratory Data Analysis

```{r}

##### WE DON'T NEED THIS ANYMORE #####

#grabbing the data
data <- read.csv('stock_data_all.csv')

# reformatting data
names(data) <- tolower(names(data))


#rename columns
data <- data %>%
  na.omit %>%
  rename('adj_close' = 'adj.close',
         'macd_signal' = 'macd.signal')

data <- data %>%
  separate(col='date',into =c('year','month','day'),sep='\\/') %>%
  unite(date,c('year','month','day'),sep = '-')
  

data$date <- as.Date(data$date)
```

### a. Reading in the Data (Stock Adjusted Closing Prices & Sentiment Scores)

The data is derived from Yahoo Finance and we calculated the technical indicators in Python

```{r}

aapl <- read_csv('aapl_stock.csv')

aapl <- aapl %>%
  separate(col = 'Date', into = c('year', 'month', 'day'), sep='-') %>%
  unite(date, c('year', 'month', 'day'), sep = '-')

aapl$date <- as.Date(aapl$date)

aapl <- aapl %>%
  na.omit %>%
  rename('adj_close' = 'Adj Close',
         'macd_new' = 'MACD-NEW',
         'percent_change' = 'Percent_Changes')

names(aapl) <- tolower(names(aapl))

aapl <- aapl %>%
  select(-close, -high, -low, -open)


# the sentiment scores will be a separate dataset, since
# we actually do not have values for every day in the sentiment scores to do a full in-depth analysis of its stock prices
aapl_sentiment <- read_csv('sentiment_aapl.csv')

aapl_sentiment <- aapl_sentiment %>%
  select(-body) %>%
  group_by(date) %>%
  summarize(sentiment_score = mean(sentiment_score))

aapl_sentiment <- inner_join(aapl, aapl_sentiment, by='date')
```

```{r}

##### WE DON'T NEED THIS ANYMORE #####

#creates a lagged column

aapl <- aapl %>% 
  mutate(lead_adj_close = lead(adj_close,n=1)) %>%
  mutate(diff = lead_adj_close-adj_close) %>%
  mutate(pos_neg = ifelse(diff > 0,'pos','neg')) %>%
  #select(-lag_adj_close) %>%
  na.omit %>% 
  mutate(macd_diff = macd_signal - macd,
         ema_diff = (ema - adj_close) / adj_close) %>%
  select(-sma)
```

### b. Create a Correlation Matrix

```{r}

aapl_sentiment <- aapl_sentiment %>%
  mutate(sma_diff = adj_close - sma, ema_diff = adj_close - ema) %>%
  select(-sma, -ema)

#demonstrating correlation of variables with only Apple stocks
aapl_sentiment %>%
  select(-date,-ticker, -adj_close, -volume, -sma_diff, -`macd-signal`, -macd) %>%
  cor %>%
  ggcorrplot
```

### **Correlation Matrix**

**we need to change this later but for now i will keep messing around the periods in python to get the best data possible for us**

The highest correlated variables are the SMA with open, low, high close, and adjusted close which are attributes of a stock price. The same can also be seen with the EMA and stock information. The lowest correlated variables are MACD, MACD SIGNAL, Diff, and RSI against stock prices.

# **Visualizations of Relationships cross the Variables**

### **a. Wei-Yu's Visualizations**

#### i. Relative Strength Index Visualization

```{r}
# we are plotting the RSI values for the first 100 days of stock market data
aapl_price <- aapl %>%
  slice(1:100) %>%
  ggplot()+
  geom_line(aes(x = date,y=adj_close))

aapl_rsi <- aapl %>%
  slice(1:100) %>%
  ggplot(aes(x=date,y=rsi)) +
  geom_line() + 
  geom_hline(yintercept = 70, linetype='dashed', color = 'orange') +
  geom_hline(yintercept = 30, linetype='dashed', color = 'orange')

grid.arrange(aapl_price,aapl_rsi, ncol=1)
```

**Relative Strength Index**

The RSI is separated from the graph because it is calculated from the percentage gain/loss of stock prices. Typically, when the RSI is above 70 then the stock is overbought and when the score is below 30 it is oversold. People usually want to sell stocks when it is overbought and buy when the stocks are oversold. Here we can see instances of when the RSI score is very high and is followed with a downward trend because it is overbought.

![](images/Capture.JPG)

#### ii. Simple Moving Average

```{r}

data %>% 
  filter(ticker=='AAPL') %>%
  ggplot() +
  geom_line(aes(x=date,y=adj_close)) +
  geom_line(aes(x=date,y=ema),color='red')

```

**Simple Moving Average**

The simple moving average is calculated based on the prices of previous days. It computes an average and overlaps onto the line graph of price because it is specific to that price. This tool is used to look at upward and downward trends as it allows people to see how the price is performing based on an average. For example, around 2021-07, price (black line) stays above the SMA (red line) for many days because it keeps performing better than its average. We can watch out for when the price crosses the SMA which could indicate price changing directions.

### **b. Abhinav's Visualizations**

#### iii. Moving Average Convergence/ Divergence (MACD)

```{r}

stock_plot <- aapl %>%
  slice(1:100) %>%
  ggplot() +
  geom_line(aes(x = date, y = adj_close))

macd_plot <- aapl %>%
  slice(1:100) %>%
  ggplot() +
  geom_line(aes(x = date, y = macd)) +
  geom_line(aes(x = date, y = aapl$macd_signal))

grid.arrange(stock_plot,macd_plot, ncol=1)
```

## 3. Prediction and Cross-validation

### **Wei-Yu's Prediction**

```{r}

fit_lin <- lm(diff~ema_diff + rsi + volume + macd_diff + adj_close, data = aapl)


pred_lin <- aapl %>%
  mutate(predictions = predict(fit_lin)) %>%
  select(adj_close,predictions,date,diff)

pred_lin %>% 
  ggplot() +
  geom_line(aes(x=date,y=diff)) +
  geom_line(aes(x=date,y=predictions),color='red')

rmse(pred_lin$adj_close,pred_lin$predictions)

summary(fit_lin)$r.squared
```

**(First 60 days of graph above)**

```{r}
pred_lin %>% 
  slice(1:60) %>%
  ggplot() +
  geom_line(aes(x=date,y=diff)) +
  geom_line(aes(x=date,y=predictions),color='red')
```

### Cross-validation

```{r}
#seed <- set.seed(10)
TimeControl <- trainControl(method = 'timeslice',
                            initialWindow = 55,
                            horizon = 55)


train(adj_close~sma + ema + macd_diff + rsi + volume,
      data = aapl,
      method = 'lm',
      trControl = TimeControl
)


```

## 4. Dimensionality Reduction

**Additional Data Preparation**

```{r}

aapl$volume <- as.double(aapl$volume)

aapl_scaled <- aapl %>%
  select_if(is.double) %>%
  select(!(1:6)) %>%
  select(-diff) %>%
  scale %>%
  as.data.frame

head(aapl_scaled)
```

```{r}
pca <- aapl_scaled %>%
  prcomp


fviz_eig(pca, addlabels = TRUE, ylim = c(0, 60))

```

**We will keep the first two principal components for total of 79.6% explained variance.**

```{r}
fviz_pca_ind(pca) 
```

## 5. Clustering

**PAM Clustering**

```{r}

fviz_nbclust(aapl_scaled, pam, method = "silhouette")
```

**We will choose to use two clusters.**

```{r}
pam_results <- aapl_scaled %>%
  pam(k = 2)

fviz_cluster(pam_results)

```

```{r}
aapl  %>%
  mutate(cluster = as.factor(pam_results$clustering)) %>%
  group_by(cluster) %>%
  summarize_if(is.numeric, mean, na.rm = T)
```
